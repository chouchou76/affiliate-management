<button class="open-btn" (click)="openPopup()">Thêm bản ghi</button>

<div class="popup-container" *ngIf="isPopupOpen">
  <div class="popup-header">
    <h2>{{ form.value.channelName || 'Bảng ghi không có tiêu đề' }}</h2>
    <button class="close-btn" (click)="closePopup()">×</button>
  </div>

  <div class="popup-content">
    <form [formGroup]="form" (ngSubmit)="saveKoc()" class="form-grid">

      <!-- BASIC INFO -->
      <div class="field-row">
        <label>Tên Kênh</label>
        <input type="text" formControlName="channelName">
      </div>

      <div class="field-row">
        <label>Link Kênh</label>
        <input type="text" formControlName="linkChannel">
      </div>

      <div class="field-row">
        <label>Ngày Tìm</label>
        <input type="date" formControlName="dateFound">
      </div>

      
      <div class="field-row">
        <label>Nhân Viên</label>
        <input type="text" formControlName="staff" readonly>
      </div>

      <div class="field-row">
        <label>Quản Lý</label>
        <input type="text" formControlName="manager" readonly>
      </div>

      <div class="field-row">
        <label>Cast</label>
        <input type="number" formControlName="cast">
      </div>

      <div class="field-row">
        <label>Hoa Hồng</label>
        <input type="text" formControlName="commission">
      </div>

      <div class="field-row">
        <label>Ghi Chú</label>
        <input type="text" formControlName="note">
      </div>

      <!-- LABELS -->
      <div class="field-row">
        <label>Nhãn hàng</label>

        <div class="select-wrapper">
          <div class="select-box" (click)="openLabelDropdown()">
            <span
              class="tag"
              *ngFor="let l of form.value.labels; let i = index"
              [ngClass]="getColor('products', l)"
            >
              {{ l }}
              <span class="remove" (click)="removeLabel(i); $event.stopPropagation()">×</span>
            </span>

            <span class="placeholder" *ngIf="!form.value.labels || form.value.labels.length === 0">
              Vui lòng lựa chọn
            </span>
          </div>

          <div class="dropdown" *ngIf="labelOpen">
            <span
              class="tag"
              *ngFor="let l of availableLabels"
              [ngClass]="getColor('products', l)"
              (click)="selectLabel(l)"
            >
              {{ l }}
            </span>
          </div>
        </div>
      </div>

      <div class="field-row">
        <label>Sản phẩm</label>

        <div class="product-box" (click)="openDropdown()">
          <span
            class="product-tag"
            *ngFor="let p of form.value.products; let i = index"
            [ngClass]="getColor('products', p)"
          >
            {{ p }}
            <span class="remove" (click)="removeTag('products', i); $event.stopPropagation()">×</span>
          </span>
        </div>

        <div class="product-dropdown" *ngIf="isOpen">
          <input
            type="text"
            placeholder="Chọn hoặc nhập sản phẩm"
            [(ngModel)]="productInput"
            [ngModelOptions]="{ standalone: true }"
            (input)="filterProducts()"
            (keydown.enter)="onEnter(); $event.preventDefault()"
            #productInputEl
            [class.has-value]="productInput"
          />

          <div
            class="dropdown-item"
            *ngFor="let p of filteredProducts"
            (click)="selectProduct(p, $event)"
            (click)="addProductToForm(p.name)"
          >
            {{ p.name }}
          </div>

          <div
            class="dropdown-add"
            *ngIf="filteredProducts.length === 0 && productInput"
            (click)="onEnter()"
          >
            <span class="product-tag preview-tag">
              {{ productInput }}
              <span class="remove">×</span>
            </span>
          </div>
        </div>
      </div>
      
      <!-- STATUS -->
      <div class="field-row">
  <label>Trạng thái</label>

  <div class="select-wrapper">
    <div class="select-box" (click)="openStatusDropdown()">
      <span
        class="tag"
        *ngIf="form.value.status"
        [ngClass]="getColor('statuses', form.value.status)"
      >
        {{ form.value.status }}
      </span>

      <span class="placeholder" *ngIf="!form.value.status">
        Chọn trạng thái
      </span>
    </div>

    <div class="dropdown" *ngIf="statusOpen">
      <span
        class="tag"
        *ngFor="let s of availableStatuses"
        [ngClass]="getColor('statuses', s)"
        (click)="selectStatus(s)"
      >
        {{ s }}
      </span>
    </div>
  </div>
</div>
     

      <!-- TIMELINE -->
      <div class="field-row">
        <label>Ngày Gửi Mẫu</label>
        <input type="date" formControlName="sampleSendDate">
      </div>

      <div class="field-row">
        <label>Ngày Air Dự Kiến</label>
        <input type="date" formControlName="expectedAirDate">
      </div>

      <div class="field-row">
        <label>Ngày Air Thực Tế</label>
        <input type="date" formControlName="actualAirDate">
      </div>

      <!-- TIKTOK -->
      <div class="field-row">
        <label>Link video TikTok</label>
        <input type="text" formControlName="videoLink">
        <button type="button" (click)="crawlTikTok()" [disabled]="isCrawling">
          {{ isCrawling ? 'Đang cào...' : 'Cào dữ liệu' }}
        </button>
      </div>

      <div class="field-row">
        <label>ID Video TikTok</label>
        <input type="text" formControlName="videoId" readonly>
      </div>

      <div class="field-row">
        <label>GMV</label>
        <input type="number" formControlName="gmv" readonly>
      </div>

      <div class="field-row">
        <label>View</label>
        <input type="number" formControlName="views" readonly>
      </div>

      <div class="field-row">
        <label>Like</label>
        <input type="number" formControlName="likes" readonly>
      </div>

      <div class="field-row">
        <label>Comment</label>
        <input type="number" formControlName="comments" readonly>
      </div>

      <div class="field-row">
        <label>Share</label>
        <input type="number" formControlName="shares" readonly>
      </div>

      <div class="field-row">
        <label>Save</label>
        <input type="number" formControlName="saves" readonly>
      </div>

      <div class="field-row">
        <label>Title</label>
        <input type="text" formControlName="title" readonly>
      </div>

      <div class="field-row">
        <label>Data Retrieval Time</label>
        <input type="text" formControlName="dataRetrievalTime" readonly>
      </div>

      <div class="form-actions">
        <button type="submit">Lưu</button>
        <button type="button" (click)="closePopup()">Hủy</button>
      </div>

    </form>
  </div>
</div>

